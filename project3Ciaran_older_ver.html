<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href="grid12.css" rel="stylesheet">
<title> Project </title>
<script type="text/javascript">

  var numGrid = 3;

  //a 2D array of cells (elements)
  var board = new Array(numGrid);
  for(var i=0; i<numGrid; i++)
    board[i] = new Array(numGrid);

  var gameOver = false;
  var winner;

  var player1 = new User();
  var player2 = new Computer(notSoRandomCoord);
  player1.opponent = player2;
  player2.opponent = player1;

  var currentPlayer = player1;

  //start!
  function startGame() {
    currentPlayer.move();
  }
  
  function User() {
    this.opponent;
    this.move = function() {
      //get ready for user's move by making grids clickable and wait for user's click
      for(var i=0; i<numGrid; i++) {
        for(var j=0; j<numGrid; j++) 
          board[i][j].setAttribute('onClick','placeLetter(this)');
      }
    }
  }

  function Computer(algorithm) {
    this.opponent;
    this.move = function() {
      //make grids unclickable. 
      for(var i=0; i<numGrid; i++) {
        for(var j=0; j<numGrid; j++) {
          board[i][j].setAttribute('onClick','');
        }
      }
      //This while loop simulates a click.
      var coord = algorithm();
      console.log(coord);
      if(board[coord.r][coord.c].innerHTML != '') console.log('error: placed at somewhere occupied');
      setTimeout(function(){
        placeLetter(board[coord.r][coord.c]);
      },1000);
    }
  }

  //generates a random move (returns a Coordinate)
  function randomCoord() {
    while(true) {
      var r = Math.floor(Math.random()*numGrid);
      var c = Math.floor(Math.random()*numGrid);
      if(board[r][c].innerHTML == '') return new Coordinate(r,c);
    }
  }

  var Xhori = 0; var Ohori = 0;
  var Xvert = 0; var Overt = 0;
  var Xdiag1 = 0; var Odiag1 = 0;
  var Xdiag2 = 0; var Odiag2 = 0;
  /*
  Attempt to make a better AI than pure random
  If there's somewhere only one step away from winning, or one step from losing, AI makes a move there.
  */
  function notSoRandomCoord() 
  {
    Xhori=0; Ohori=0;
    Xvert=0; Overt=0;
    Xdiag1=0; Odiag1=0;
    Xdiag2=0; Odiag2=0;
    for(var i=0; i<numGrid; i++) 
    {
      //count diagonal Xs and Os
      if(board[i][i].innerHTML == 'X') Xdiag1++;
      else if(board[i][i].innerHTML == 'O')Odiag1++;
      if(board[i][numGrid-1-i].innerHTML == 'X') Xdiag2++;
      else if(board[i][numGrid-i-1].innerHTML == 'O')Odiag2++;

      //Last loop, should've counted all XOdiags. any diagonal almost-win?
      if(i==numGrid-1 && (Xdiag1 == numGrid-1 || Odiag1 == numGrid-1) && AIhelper('diag1') != false) 
      {
        console.log('count: ' + Xdiag1 + ' ' + Odiag1);
        return AIhelper('diag1');
      }
      else if(i==numGrid-1 && (Xdiag2 == numGrid-1 || Odiag2 == numGrid-1) && AIhelper('diag2') != false) 
      {
        console.log('count: ' + Xdiag2 + ' ' + Odiag2);
        return AIhelper('diag2');
      }

      //no? check for horizontals and verticals.
      else 
      {
        for (var j=0; j<numGrid; j++) {
          //horizontal
          if(board[i][j].innerHTML == 'X') Xhori++;
          else if(board[i][j].innerHTML == 'O')Ohori++;
          //vertical
          if(board[j][i].innerHTML == 'X') Xvert++;
          else if(board[j][i].innerHTML == 'O') Overt++;
          
          //Last inner loop. Check for vertical almost-win.
          if(j==numGrid-1 && (Xvert == numGrid-1 || Overt == numGrid-1) && AIhelper('vert',i) != false) {
            console.log('count: ' + Xvert + ' ' + Overt);
            return AIhelper('vert',i);
          } 
        }
        //check for horizontal almost-win.
        if((Xhori == numGrid-1 || Ohori == numGrid-1) && AIhelper('hori',i) != false) {
          console.log('count: ' + Xhori + ' ' + Ohori);
          return AIhelper('hori',i);
        }
        //reset horizontal and vertical count variables
        Xhori = 0; Ohori = 0; Xvert = 0; Overt = 0;
      }
    }
    var tmp = randomCoord();
    console.log ('random: ');
    return tmp;
  }


  //If there's an only empty Coordinate in a certain row/column/diagonal line, return it.
  function AIhelper(direction, num) {
    console.log(direction + ' ' + num);
    if(direction == 'diag1') {
      //top left to bottom right
      for (var i=0; i<numGrid; i++) 
        if(board[i][i].innerHTML == '') return new Coordinate(i,i);
    } else if (direction == 'diag2') {
      //top right to bottom left
      for (var i=0; i<numGrid; i++) 
        if(board[i][numGrid-i-1].innerHTML == '') {
          /*console.log(i+' ' + numGrid-1-i);*/return new Coordinate(i,numGrid-i-1);}
    } else if (direction == 'hori') {
      //num, ?
      for (var i=0; i<numGrid; i++) 
        if(board[num][i].innerHTML == '') return new Coordinate(num,i);
    } else if (direction == 'vert') {
      //?, num
      for (var i=0; i<numGrid; i++)
        if(board[i][num].innerHTML == '') return new Coordinate(i,num);
    }
    console.log('last was false');
    return false;
  }
  
  function Coordinate(r, c) {
    this.r = r;
    this.c = c;
  }

  /*
  Evenly divides #container into numGrid rows and numGrid columns of cells
  And store them into board for later access
  */
	function generateCells()
  {
    var container = document.getElementById('container');
    var proportion = 100/numGrid;//percentage of width or height per cell

    for(var i=0; i<numGrid; i++) {
      //create and add row
      var row = document.createElement('div');
      row.style.height = proportion + '%';
      row.className = 'row';
      container.appendChild(row);
      for(var j=0; j<numGrid; j++) {
        //create and add cell
        var cell = document.createElement('div');
        cell.className='cell';
        cell.style.position = 'relative';
        cell.style.float = 'left';
        cell.style.width = proportion + '%';
        row.appendChild(cell);
        //add this cell to board (2D array)
        board[i][j] = cell;
      }
    }
  }

  function placeLetter(element) {
    if(!gameOver){
      //It's user's turn, place an X.
      if(currentPlayer == player1) {
        if(element.innerHTML != '') {
          //User clicked on a grid where there's already a letter. Doesn't do anything.
          return;
        }
        element.className = 'cell X';
        element.style.lineHeight = container.clientHeight/numGrid + 'px';
        element.innerHTML = 'X';
      } else {
        //It's computer's turn, place an O.
        element.className = 'cell O';
        element.style.lineHeight = container.clientHeight/numGrid + 'px';
        element.innerHTML = 'O';
      }

      winner = detectWin();
      if(gameOver) {
        //end the game
        console.log('Winner: ' + winner);
        //make grids unclickable. 
        for(var i=0; i<numGrid; i++) {
          for(var j=0; j<numGrid; j++) {
            board[i][j].setAttribute('onClick','');
          }
        }
      } else {
        //change player
        currentPlayer = currentPlayer.opponent;
        currentPlayer.move();
      }
    }
  }

  /*
  return 'X' if X wins, or return 'O' if O wins. 
  return 'tie' if the whole board is filled but nobody wins.
  Otherwise doesn't change or return anything.
  */
  function detectWin() 
  {
    var letterCount = 0;
    var Xhori = 0; var Ohori = 0;
    var Xvert = 0; var Overt = 0;
    var Xdiag1 = 0; var Odiag1 = 0;
    var Xdiag2 = 0; var Odiag2 = 0;
    for(var i=0; i<numGrid; i++) 
    {
      //diagonal 1
      if(board[i][i].innerHTML == 'X') Xdiag1++;
      else if(board[i][i].innerHTML == 'O')Odiag1++;
      //diagonal 2
      if(board[i][numGrid-1-i].innerHTML == 'X') Xdiag2++;
      else if(board[i][numGrid-i-1].innerHTML == 'O')Odiag2++;
      //any diagonal win, after going through this outer loop check?
      if(Xdiag1 == numGrid || Xdiag2 == numGrid) {gameOver = true; return 'X';}
      else if(Odiag1 == numGrid || Odiag2 == numGrid) {gameOver = true; return 'O';}
      //no? check for horizontal and vertical.
      else 
      {
        for (var j=0; j<numGrid; j++) 
        {
          //count towards checking if the whole board is filled.
          if(board[i][j].innerHTML != '') letterCount++;
          //horizontal
          if(board[i][j].innerHTML == 'X') Xhori++;
          else if(board[i][j].innerHTML == 'O')Ohori++;
          //vertical
          if(board[j][i].innerHTML == 'X') Xvert++;
          else if(board[j][i].innerHTML == 'O')Overt++;
        }
        //any horizantal or vertical win, after running this inner loop?
        if(Xhori == numGrid || Xvert == numGrid) {gameOver = true; return 'X';}
        else if(Ohori == numGrid || Overt == numGrid) {gameOver = true; return 'O';}
        //reset horizontal and vertical count variables
        Xhori = 0; Ohori = 0; Xvert = 0; Overt = 0;
      }
    }
    //is the whole board filled?
    if(letterCount == numGrid**2) {gameOver = true; return 'tie';}
  }

</script>
<style>
  *{
    margin:0;
    padding:0;
  }

  div.cell{
    margin:0;
    padding:0;
    height:100%;
    border:2px solid black;
  }
  div.cell:hover{
    background-color: #ffffcc;
  }

  .X,.O{
    width:100%;
    height:100%;
    font-size:72px;
    text-align:center;
    vertical-align:middle;
  }
  #container{
    width:800px;
    height:600px;
  }
  #title{
    text-align:center;
  }

</style>
</head>
<body onload="generateCells(); startGame();">
  <div class="container">
    <h3 id="title">A placeholder title</h3>
    <div id="container" class="container-fluid"></div>
  </div>
</body>
</html>